# Square Bookings Sync 使用指南

这个工具可以自动在客户预约"情侣按摩"时，为第二个治疗师创建占位预约。

## 📋 使用步骤

### 第一步：安装依赖包

打开命令行（PowerShell 或 CMD），在项目文件夹中运行：

```bash
pip install -r requirements.txt
```

### 第二步：配置 Square API 凭证

1. **复制配置文件**：
   ```powershell
   Copy-Item env.example .env
   ```

2. **获取 Square API 凭证**：
   - 登录 [Square Developer Dashboard](https://developer.squareup.com/)
   - 创建应用或使用现有应用
   - 获取 **Access Token**（访问令牌）
   - 获取 **Location ID**（位置ID，在 Square 后台的"设置 > 位置"中查看）

3. **编辑 `.env` 文件**，填入以下必填信息：
   ```
   SQUARE_ACCESS_TOKEN=你的访问令牌
   SQUARE_LOCATION_ID=你的位置ID
   SQUARE_ENVIRONMENT=sandbox
   ```
   - `sandbox` = 测试环境（先用这个测试）
   - `production` = 生产环境（正式使用）

### 第三步：测试连接

运行测试脚本，确认配置正确：

```bash
python test_connection.py
```

如果看到 ✓ 标记，说明配置成功！

### 第四步：选择运行模式

有两种运行模式，推荐先用**轮询模式**测试：

#### 方式一：轮询模式（简单，适合测试）

直接运行：

```bash
python polling_mode.py
```

这个程序会每 60 秒检查一次新的预约，如果发现"情侣按摩"预约，会自动为第二个治疗师创建占位。

**优点**：不需要设置 webhook，开箱即用  
**缺点**：不是实时的，最多有 60 秒延迟

#### 方式二：Webhook 模式（实时，适合生产环境）

1. **安装 ngrok**（用于暴露本地服务器）：
   - 下载：https://ngrok.com/
   - 安装后运行：`ngrok http 5000`

2. **在 Square Developer Dashboard 配置 Webhook**：
   - 进入你的应用 > Webhooks
   - 添加 webhook URL：`https://你的ngrok地址.ngrok.io/webhook`
   - 订阅事件：`booking.created` 和 `booking.updated`

3. **启动服务器**：
   ```bash
   python main.py
   ```

**优点**：实时响应，延迟低  
**缺点**：需要配置 webhook 和 ngrok

### 第五步：测试

1. 在 Square Appointments 中创建一个测试预约，服务名称包含"couple"（或"情侣"）
2. 查看命令行日志，应该看到：
   - 检测到情侣按摩预约
   - 找到可用治疗师
   - 创建第二个预约占位
3. 在 Square Appointments 日历中检查，应该看到两个治疗师都被占用了

## ⚙️ 高级配置（可选）

在 `.env` 文件中可以添加以下可选配置：

```
# 服务识别（二选一）
COUPLES_MASSAGE_SERVICE_ID=你的服务ID（如果知道的话）
COUPLES_MASSAGE_SERVICE_NAME_PATTERN=couple  # 或 "情侣"、"couple" 等关键词

# 指定哪些治疗师可以用于情侣按摩（留空则使用所有可用治疗师）
THERAPIST_TEAM_MEMBER_IDS=治疗师ID1,治疗师ID2

# Webhook 配置
WEBHOOK_SECRET=你的webhook密钥（用于验证）
WEBHOOK_PORT=5000
```

## ❓ 常见问题

**Q: 没有创建第二个预约？**  
A: 
- 检查日志是否有错误
- 确认服务名称包含"couple"（或修改 `COUPLES_MASSAGE_SERVICE_NAME_PATTERN`）
- 确认有可用的治疗师（不是第一个治疗师）

**Q: 出现认证错误？**  
A:
- 检查 `SQUARE_ACCESS_TOKEN` 是否正确
- 确认使用的是正确的环境（sandbox 还是 production）

**Q: Webhook 收不到事件？**  
A:
- 确认 ngrok 正在运行且 URL 可访问
- 检查 Square Developer Dashboard 中的 webhook 配置
- 检查防火墙设置

**Q: 如何识别"情侣按摩"服务？**  
A:
- 默认情况下，程序会查找服务名称中包含"couple"的预约
- 可以在 `.env` 中设置 `COUPLES_MASSAGE_SERVICE_NAME_PATTERN=情侣` 来匹配中文
- 或者使用 `COUPLES_MASSAGE_SERVICE_ID` 指定具体的服务ID

## 📝 工作原理

1. **检测**：当有新预约创建或更新时，检查是否是"情侣按摩"
2. **识别**：通过服务ID或服务名称模式匹配（默认查找"couple"）
3. **查找**：找一个可用的治疗师（排除已经分配的那个）
4. **创建**：为第二个治疗师创建一个占位预约
5. **跟踪**：维护主预约和次预约之间的映射关系
6. **清理**：自动处理取消和重新安排的情况

## 🚀 开始使用

最简单的方式：

1. 运行 `pip install -r requirements.txt`
2. 复制 `env.example` 为 `.env` 并填入你的 Square 凭证
3. 运行 `python polling_mode.py`
4. 在 Square 中创建一个测试预约看看效果！

祝使用愉快！如有问题，请查看日志文件或检查配置。

